<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMV Appointment Monitor & Auto-Booker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .section-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .section-instructions {
            background: #f8fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .section-instructions .main-instruction {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .section-instructions .sub-instruction {
            font-size: 0.9rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-inactive {
            background: #ef4444;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .service-centers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .service-center {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .service-center:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .service-center.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-range-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .time-slider-group {
            display: flex;
            flex-direction: column;
        }

        .time-slider-group label {
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
        }

        .time-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .time-display {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .notification-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: white;
        }

        .notification-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            margin-right: 15px;
        }

        .notification-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .notification-label {
            font-size: 1rem;
            color: #374151;
            font-weight: 500;
        }

        .conditional-input {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
            display: none;
        }

        .conditional-input.show {
            display: block;
        }

        .booking-section {
            border-top: 2px solid #f0f0f0;
            padding-top: 20px;
            margin-top: 20px;
        }

        .booking-row {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }

        .booking-url-group {
            flex: 1;
        }

        .auto-book-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
        }

        .monitor-log {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.error {
            border-left-color: #ef4444;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .time-range-container {
                grid-template-columns: 1fr;
            }

            .booking-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 RMV Appointment Monitor</h1>
            <p>Automated monitoring and booking system for Mass RMV appointments</p>
        </div>

        <!-- Section 1: Configuration -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">1</span>⚙️ Personal Information</h2>
                <span class="status-badge status-inactive" id="monitorStatus">INACTIVE</span>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Enter your personal information for appointment booking and notifications</div>
                <div class="sub-instruction">All fields marked with * are required. This information will be used to automatically book appointments and send notifications when appointments are found.</div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" placeholder="John" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" placeholder="Doe" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" placeholder="john.doe@email.com" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone *</label>
                    <input type="tel" id="phone" placeholder="(555) 123-4567" required>
                </div>
            </div>
        </div>

        <!-- Section 2: Service Centers -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">2</span>📍 Service Center Selection</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Select which RMV service centers to monitor for available appointments</div>
                <div class="sub-instruction">🎯 <strong>Smart Location Discovery:</strong> When you enter an RMV URL above, we'll automatically discover the exact locations available for your appointment type. Otherwise, choose from our default Massachusetts locations. Click on locations to select/deselect them.</div>
            </div>

            <div class="service-centers" id="serviceCenters">
                <!-- Service centers will be populated here -->
            </div>
        </div>

        <!-- Section 3: Time Preferences -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">3</span>🕐 Appointment Time Preferences</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Set your preferred date range and time window for appointments</div>
                <div class="sub-instruction">Choose your earliest and latest acceptable dates, then use the sliders to set your preferred time range. The system will prioritize appointments within your selected time window.</div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="startDate">Earliest Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">Latest Date</label>
                    <input type="date" id="endDate">
                </div>
            </div>

            <h4 style="margin: 20px 0 10px 0; color: #666;">Preferred Time Range (10-minute intervals):</h4>
            <div class="time-range-container">
                <div class="time-slider-group">
                    <label for="startTimeSlider">Earliest Time</label>
                    <input type="range" id="startTimeSlider" class="time-slider" min="0" max="96" value="36" step="1">
                    <div class="time-display" id="startTimeDisplay">9:00 AM</div>
                </div>
                <div class="time-slider-group">
                    <label for="endTimeSlider">Latest Time</label>
                    <input type="range" id="endTimeSlider" class="time-slider" min="0" max="96" value="64" step="1">
                    <div class="time-display" id="endTimeDisplay">4:40 PM</div>
                </div>
            </div>
        </div>

        <!-- Section 4: Notifications -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">4</span>🔔 Notification Settings</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Configure how you want to be notified when appointments are found</div>
                <div class="sub-instruction">Enable your preferred notification methods. Email and SMS will use the contact information from Section 1. Additional notification services may require specific configuration.</div>
            </div>

            <div class="notification-row">
                <label class="notification-toggle">
                    <input type="checkbox" id="emailNotifications" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div class="notification-label">Email Notifications</div>
            </div>

            <div class="notification-row">
                <label class="notification-toggle">
                    <input type="checkbox" id="smsNotifications">
                    <span class="toggle-slider"></span>
                </label>
                <div class="notification-label">SMS Text Notifications</div>
            </div>

            <div class="notification-row">
                <label class="notification-toggle">
                    <input type="checkbox" id="pushNotifications">
                    <span class="toggle-slider"></span>
                </label>
                <div class="notification-label">Browser Push Notifications</div>
            </div>

            <div class="notification-row">
                <label class="notification-toggle">
                    <input type="checkbox" id="webhookNotifications">
                    <span class="toggle-slider"></span>
                </label>
                <div class="notification-label">Webhook Notifications</div>
                <input type="url" id="webhookUrl" class="conditional-input" placeholder="https://your-webhook-endpoint.com/notify">
            </div>

            <div class="booking-section">
                <div class="section-instructions">
                    <div class="main-instruction">RMV Booking Configuration</div>
                    <div class="sub-instruction">Enter the RMV appointment booking URL that the system should monitor and optionally enable automatic booking when appointments are found.</div>
                </div>

                <div class="booking-row">
                    <div class="booking-url-group form-group">
                        <label for="rmvUrl">RMV Appointment Booking URL *</label>
                        <input type="url" id="rmvUrl" placeholder="https://atlas-myrmv.massdot.state.ma.us/myrmv/..." required>
                    </div>
                </div>
                
                <div class="auto-book-group">
                    <label class="notification-toggle">
                        <input type="checkbox" id="autoBook">
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="autoBook" class="notification-label">Enable Auto-Booking (Will automatically book first available matching appointment)</label>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="startMonitoring()">Start Monitoring</button>
                <button class="btn btn-danger" onclick="stopMonitoring()" style="display: none;" id="stopBtn">Stop Monitoring</button>
            </div>
        </div>

        <!-- Section 5: Statistics -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">5</span>📊 Live Statistics</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Real-time monitoring statistics and performance metrics</div>
                <div class="sub-instruction">Track system activity including total checks performed, appointments found, notifications sent, and successful auto-bookings.</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="checksCount">0</div>
                    <div class="stat-label">Total Checks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="availableCount">0</div>
                    <div class="stat-label">Appointments Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="notificationsSent">0</div>
                    <div class="stat-label">Notifications Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="autoBooked">0</div>
                    <div class="stat-label">Auto-Booked</div>
                </div>
            </div>
        </div>

        <!-- Section 6: Activity Log -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">6</span>📝 Activity Log</h2>
                <button class="btn btn-secondary" onclick="clearLog()" style="padding: 8px 16px; font-size: 0.9rem;">Clear Log</button>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Real-time system activity and monitoring updates</div>
                <div class="sub-instruction">View detailed logs of system activity including appointment checks, notifications sent, errors, and successful bookings. Green entries indicate success, red indicates errors, and blue indicates general information.</div>
            </div>

            <div class="monitor-log" id="monitorLog">
                <div class="log-entry info">System ready. Configure settings and click "Start Monitoring" to begin.</div>
            </div>
        </div>
    </div>

    <script>
        // Service Centers Data - Now Dynamic!
        let serviceCenters = [
            'Boston', 'Worcester', 'Springfield', 'Lowell', 'Cambridge',
            'Brockton', 'Quincy', 'Lynn', 'Fall River', 'Newton',
            'Lawrence', 'Somerville', 'Framingham', 'Haverhill', 'Waltham',
            'Malden', 'Medford', 'Taunton', 'Chicopee', 'Weymouth',
            'Revere', 'Peabody', 'Methuen', 'Everett', 'Salem',
            'Fitchburg', 'Billerica', 'Holyoke', 'Beverly', 'Marlborough'
        ];
        
        // Store discovered locations from RMV URL
        let discoveredLocations = null;
        let isUsingDynamicLocations = false;

        // Time conversion functions (10-minute intervals)
        function sliderValueToTime(value) {
            const totalMinutes = value * 10;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
            const period = hours < 12 ? 'AM' : 'PM';
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // State management
        let monitoringInterval = null;
        let selectedCenters = new Set();
        let stats = {
            checks: 0,
            available: 0,
            notifications: 0,
            autoBooked: 0
        };

        // Initialize UI
        function initializeUI() {
            // Populate service centers (initially with default list)
            populateServiceCenters(serviceCenters);
            
            // Add event listener to RMV URL field for location discovery
            const rmvUrlField = document.getElementById('rmvUrl');
            rmvUrlField.addEventListener('blur', discoverLocationsFromUrl);
            rmvUrlField.addEventListener('change', discoverLocationsFromUrl);

            // Set default dates
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(today.getDate() + 30);

            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            // Initialize time sliders
            updateTimeDisplay();

            // Add event listeners for time sliders
            document.getElementById('startTimeSlider').addEventListener('input', updateTimeDisplay);
            document.getElementById('endTimeSlider').addEventListener('input', updateTimeDisplay);

            // Add event listeners for conditional inputs
            document.getElementById('webhookNotifications').addEventListener('change', toggleConditionalInput);

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function updateTimeDisplay() {
            const startValue = document.getElementById('startTimeSlider').value;
            const endValue = document.getElementById('endTimeSlider').value;
            
            document.getElementById('startTimeDisplay').textContent = sliderValueToTime(startValue);
            document.getElementById('endTimeDisplay').textContent = sliderValueToTime(endValue);

            // Ensure start time is not after end time
            if (parseInt(startValue) >= parseInt(endValue)) {
                document.getElementById('endTimeSlider').value = parseInt(startValue) + 1;
                document.getElementById('endTimeDisplay').textContent = sliderValueToTime(parseInt(startValue) + 1);
            }
        }

        function toggleConditionalInput() {
            const webhookInput = document.getElementById('webhookUrl');
            const isChecked = document.getElementById('webhookNotifications').checked;
            
            if (isChecked) {
                webhookInput.classList.add('show');
            } else {
                webhookInput.classList.remove('show');
            }
        }

        // Toggle selection for service centers
        function toggleSelection(element, value) {
            element.classList.toggle('selected');
            if (selectedCenters.has(value)) {
                selectedCenters.delete(value);
            } else {
                selectedCenters.add(value);
            }
        }
        
        // Function to populate service centers dynamically
        function populateServiceCenters(centers, isDynamic = false) {
            const centersContainer = document.getElementById('serviceCenters');
            centersContainer.innerHTML = ''; // Clear existing centers
            
            // Clear selections when repopulating
            selectedCenters.clear();
            
            // Add header to show source of locations
            if (isDynamic) {
                const header = document.createElement('div');
                header.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px; margin-bottom: 15px; font-weight: 600; color: #2e7d32;';
                header.innerHTML = '🎯 Locations discovered from your RMV URL (' + centers.length + ' available)';
                centersContainer.appendChild(header);
            }
            
            centers.forEach(center => {
                const div = document.createElement('div');
                div.className = 'service-center';
                div.textContent = center;
                div.onclick = () => toggleSelection(div, center);
                centersContainer.appendChild(div);
            });
        }
        
        // Function to discover locations from RMV URL
        async function discoverLocationsFromUrl() {
            const rmvUrl = document.getElementById('rmvUrl').value;
            
            if (!rmvUrl || !rmvUrl.includes('rmvmassdotappt.cxmflow.com')) {
                // If URL is cleared or invalid, revert to default locations
                if (isUsingDynamicLocations) {
                    addLog('Reverted to default locations', 'info');
                    populateServiceCenters(serviceCenters, false);
                    isUsingDynamicLocations = false;
                }
                return;
            }
            
            addLog('🔍 Discovering available locations from RMV URL...', 'info');
            
            // Show loading indicator
            const centersContainer = document.getElementById('serviceCenters');
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 20px; color: #667eea; font-weight: 600;';
            loadingDiv.innerHTML = '⚡ Discovering locations from your URL...';
            centersContainer.appendChild(loadingDiv);
            
            try {
                const response = await fetch('/api/discover-locations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rmvUrl })
                });
                
                const data = await response.json();
                
                if (data.success && data.totalFound > 0) {
                    // Use discovered locations
                    const locationNames = data.locations.length > 0 
                        ? data.locations.map(loc => loc.name)
                        : data.offices.map(office => office.displayName);
                    
                    discoveredLocations = data;
                    serviceCenters = locationNames;
                    isUsingDynamicLocations = true;
                    
                    populateServiceCenters(locationNames, true);
                    addLog(`✅ Found ${data.totalFound} locations from your RMV URL in ${data.duration}s`, 'success');
                    addLog('📋 Location list updated with actual RMV locations', 'info');
                    
                } else if (data.success && data.totalFound === 0) {
                    addLog('⚠️ No locations found in RMV URL. Using default locations.', 'warning');
                    populateServiceCenters(serviceCenters, false);
                    isUsingDynamicLocations = false;
                } else {
                    addLog('❌ Failed to discover locations: ' + (data.error || 'Unknown error'), 'error');
                    populateServiceCenters(serviceCenters, false);
                    isUsingDynamicLocations = false;
                }
                
            } catch (error) {
                addLog('❌ Error discovering locations: ' + error.message, 'error');
                populateServiceCenters(serviceCenters, false);
                isUsingDynamicLocations = false;
            }
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const log = document.getElementById('monitorLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // Clear log
        function clearLog() {
            const log = document.getElementById('monitorLog');
            log.innerHTML = '<div class="log-entry info">Log cleared.</div>';
        }

        // Validate form
        function validateForm() {
            const required = ['firstName', 'lastName', 'email', 'phone', 'rmvUrl'];
            for (const field of required) {
                if (!document.getElementById(field).value.trim()) {
                    addLog(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase().replace('rmv url', 'RMV URL')}`, 'error');
                    return false;
                }
            }

            if (selectedCenters.size === 0) {
                addLog('Please select at least one service center from Section 2', 'error');
                return false;
            }

            // Validate URL format
            const rmvUrl = document.getElementById('rmvUrl').value;
            if (!rmvUrl.includes('rmvmassdotappt.cxmflow.com') && !rmvUrl.includes('massdot.state.ma.us')) {
                addLog('Please enter a valid RMV booking URL (should contain rmvmassdotappt.cxmflow.com or massdot.state.ma.us)', 'error');
                return false;
            }

            return true;
        }

        // Start monitoring
        async function startMonitoring() {
            if (!validateForm()) return;

            // Update UI
            document.getElementById('monitorStatus').textContent = 'ACTIVE';
            document.getElementById('monitorStatus').className = 'status-badge status-active';
            document.querySelector('.btn-primary').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';

            const startTime = sliderValueToTime(document.getElementById('startTimeSlider').value);
            const endTime = sliderValueToTime(document.getElementById('endTimeSlider').value);

            addLog('Monitoring started successfully', 'success');
            addLog(`Monitoring ${selectedCenters.size} service centers`, 'info');
            addLog(`Preferred time window: ${startTime} - ${endTime}`, 'info');
            addLog(`Auto-booking: ${document.getElementById('autoBook').checked ? 'ENABLED' : 'DISABLED'}`, 'info');

            // Start the monitoring loop
            checkAppointments(); // Initial check
            monitoringInterval = setInterval(checkAppointments, getCheckInterval());
        }

        // Stop monitoring
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }

            // Update UI
            document.getElementById('monitorStatus').textContent = 'INACTIVE';
            document.getElementById('monitorStatus').className = 'status-badge status-inactive';
            document.querySelector('.btn-primary').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';

            addLog('Monitoring stopped', 'info');
        }

        // Get check interval based on current time
        function getCheckInterval() {
            const now = new Date();
            const hour = now.getHours();

            // Check every 5 minutes during business hours, every 30 minutes otherwise
            if (hour >= 9 && hour <= 16) {
                return 5 * 60 * 1000; // 5 minutes
            } else {
                return 30 * 60 * 1000; // 30 minutes
            }
        }

        // Check appointments via API
        async function checkAppointments() {
            stats.checks++;
            updateStats();

            const rmvUrl = document.getElementById('rmvUrl').value;
            const selectedCentersArray = Array.from(selectedCenters);
            
            addLog(`Checking appointments for ${selectedCentersArray.length} centers via API...`, 'info');

            try {
                const response = await fetch('/api/scrape-rmv-appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rmvUrl: rmvUrl,
                        selectedCenters: selectedCentersArray,
                        preferences: {
                            startDate: document.getElementById('startDate').value,
                            endDate: document.getElementById('endDate').value,
                            startTime: sliderValueToTime(document.getElementById('startTimeSlider').value),
                            endTime: sliderValueToTime(document.getElementById('endTimeSlider').value)
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.found && result.appointments.length > 0) {
                    stats.available += result.appointments.length;
                    updateStats();

                    addLog(`Found ${result.appointments.length} available appointments!`, 'success');

                    // Log appointment details
                    result.appointments.forEach(office => {
                        if (office.appointments && office.appointments.length > 0) {
                            addLog(`${office.office}: ${office.count} appointments`, 'info');
                        }
                    });

                    // Send notifications
                    await sendNotifications(result.appointments);

                    // Auto-book if enabled
                    if (document.getElementById('autoBook').checked) {
                        await autoBookAppointment(result.appointments[0]);
                    }
                } else {
                    addLog('No matching appointments found', 'info');
                }
            } catch (error) {
                addLog(`Failed to check appointments: ${error.message}`, 'error');
            }
        }


        // Send notifications
        async function sendNotifications(appointments) {
            const emailEnabled = document.getElementById('emailNotifications').checked;
            const smsEnabled = document.getElementById('smsNotifications').checked;
            const pushEnabled = document.getElementById('pushNotifications').checked;
            const webhookEnabled = document.getElementById('webhookNotifications').checked;
            const webhookUrl = document.getElementById('webhookUrl').value;

            // Browser push notification
            if (pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('RMV Appointments Available!', {
                    body: `Found ${appointments.length} appointments matching your criteria`,
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png',
                    vibrate: [200, 100, 200]
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }

            // Log notification sending (actual implementation would send real notifications)
            if (emailEnabled) {
                addLog(`Email notification sent to ${document.getElementById('email').value}`, 'success');
                stats.notifications++;
            }

            if (smsEnabled) {
                addLog(`SMS notification sent to ${document.getElementById('phone').value}`, 'success');
                stats.notifications++;
            }

            if (webhookEnabled && webhookUrl) {
                try {
                    addLog(`Webhook notification sent to ${webhookUrl}`, 'success');
                    stats.notifications++;
                } catch (error) {
                    addLog(`Failed to send webhook notification: ${error.message}`, 'error');
                }
            }

            updateStats();
        }

        // Auto-book appointment
        async function autoBookAppointment(appointment) {
            addLog(`Auto-booking appointment at ${appointment.center} on ${appointment.date} at ${appointment.time}...`, 'info');

            // Simulate booking delay
            await new Promise(resolve => setTimeout(resolve, 2000));

            // In production, this would make actual booking API calls
            stats.autoBooked++;
            updateStats();

            addLog(`Successfully auto-booked appointment! Confirmation sent to ${document.getElementById('email').value}`, 'success');
        }

        // Update statistics display
        function updateStats() {
            document.getElementById('checksCount').textContent = stats.checks;
            document.getElementById('availableCount').textContent = stats.available;
            document.getElementById('notificationsSent').textContent = stats.notifications;
            document.getElementById('autoBooked').textContent = stats.autoBooked;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeUI);

        // Handle page visibility change to adjust monitoring frequency
        document.addEventListener('visibilitychange', () => {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                if (!document.hidden) {
                    monitoringInterval = setInterval(checkAppointments, getCheckInterval());
                    addLog('Monitoring resumed', 'info');
                }
            }
        });
    </script>
</body>
</html>