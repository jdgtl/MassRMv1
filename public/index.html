<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMV Appointment Monitor & Auto-Booker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .section-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .section-instructions {
            background: #f8fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .section-instructions .main-instruction {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .section-instructions .sub-instruction {
            font-size: 0.9rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-inactive {
            background: #ef4444;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .controls-container {
            display: flex;
            gap: 20px;
            margin: 20px 0 15px 0;
        }

        .regional-container {
            flex: 1;
            padding: 15px 0;
        }

        .sort-container {
            width: 280px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .control-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: left;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .sort-filter-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sort {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
        }

        .btn-sort:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .btn-sort.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-sort:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
            color: #9ca3af;
        }

        .distance-badge {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-top: 2px;
        }

        .regional-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-region {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-region:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .btn-region.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-region.btn-clear {
            border-color: #ef4444;
            color: #ef4444;
        }

        .btn-region.btn-clear:hover {
            background: #ef4444;
            color: white;
        }

        .service-centers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .service-center {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }

        .service-center:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .service-center.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .distance-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .date-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .date-input {
            width: 100%;
            padding: 10px 40px 10px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .date-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-input::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            right: 10px;
            cursor: pointer;
            width: 25px;
            height: 25px;
        }

        .date-icon {
            position: absolute;
            right: 12px;
            pointer-events: none;
            font-size: 1.2rem;
        }

        .time-range-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .time-slider-group {
            display: flex;
            flex-direction: column;
        }

        .time-slider-group label {
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
        }

        .time-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .time-display {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .notifications-inline-container {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 20px 0 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .notification-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }

        .notification-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .notification-active-info {
            text-align: left;
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 8px;
            padding: 4px 0;
            height: 32px; /* Reserve consistent space */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .notification-active-info.show {
            opacity: 1;
            visibility: visible;
        }

        .notification-active-info#pushInfo {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            height: 32px; /* Match other active states */
        }

        .webhook-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            max-width: 300px;
        }

        /* Appointments Display */
        .appointments-loading {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .appointments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .appointment-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: white;
            transition: all 0.2s ease;
        }

        .appointment-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .appointment-card.preferred {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .appointment-card.preferred::before {
            content: "‚ú® Matches Your Preferences";
            display: block;
            color: #059669;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .appointment-location {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .appointment-datetime {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .appointment-link {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: background 0.2s ease;
        }

        .appointment-link:hover {
            background: #5a67d8;
            color: white;
        }

        .no-appointments {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .no-appointments h3 {
            margin-bottom: 10px;
            color: #374151;
        }

        .countdown-timer {
            font-weight: 600;
            color: #667eea;
        }

        .notification-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            margin-right: 15px;
        }

        .notification-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .notification-label {
            font-size: 1rem;
            color: #374151;
            font-weight: 500;
        }


        .booking-section {
            border-top: 2px solid #f0f0f0;
            padding-top: 20px;
            margin-top: 20px;
        }

        .booking-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .auto-book-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .link-expiration-info {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
            font-style: italic;
        }


        .monitor-log {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.error {
            border-left-color: #ef4444;
        }

        .log-entry.info {
            border-left-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .time-range-container {
                grid-template-columns: 1fr;
            }

            .booking-grid {
                grid-template-columns: 1fr;
            }

            .controls-container {
                flex-direction: column;
                gap: 15px;
            }

            .sort-container {
                width: 100%;
            }

            .regional-buttons {
                justify-content: center;
            }

            .btn-region {
                flex: 1;
                min-width: 120px;
            }

            .notifications-inline-container {
                flex-direction: column;
                gap: 15px;
            }

            .notification-item {
                flex-direction: row;
                justify-content: flex-start;
                align-items: center;
                gap: 10px;
            }

            .webhook-input {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó RMV Appointment Monitor</h1>
            <p>Automated monitoring and booking system for Mass RMV appointments</p>
        </div>

        <!-- Section 1: Configuration -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">1</span>‚öôÔ∏è Personal Information</h2>
                <span class="status-badge status-inactive" id="monitorStatus">INACTIVE</span>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Enter your personal information for appointment booking and notifications</div>
                <div class="sub-instruction">All fields marked with * are required. This information will be used to automatically book appointments and send notifications when appointments are found.</div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" placeholder="John" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" placeholder="Doe" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" placeholder="john.doe@email.com" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone *</label>
                    <input type="tel" id="phone" placeholder="(555) 123-4567" required>
                </div>
                <div class="form-group">
                    <label for="zipCode">ZIP Code *</label>
                    <input type="text" id="zipCode" placeholder="02101" maxlength="5" pattern="[0-9]{5}" required>
                </div>
                <div class="form-group">
                    <label for="city">City/Town</label>
                    <input type="text" id="city">
                </div>
            </div>
        </div>

        <!-- Section 2: Service Centers -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">2</span>üìç Service Center Selection</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Select which RMV service centers to monitor for available appointments</div>
                <div class="sub-instruction">Choose multiple locations to increase your chances of finding an appointment. Click on locations to select/deselect them. Selected centers will be highlighted in blue. Use regional buttons for quick selection.</div>
            </div>

            <div class="controls-container">
                <div class="regional-container">
                    <div class="regional-buttons" id="regionalButtons">
                        <button class="btn-region" onclick="selectRegion('boston')">Boston Metro</button>
                        <button class="btn-region" onclick="selectRegion('worcester')">Central MA</button>
                        <button class="btn-region" onclick="selectRegion('springfield')">Western MA</button>
                        <button class="btn-region" onclick="selectRegion('north')">North Shore</button>
                        <button class="btn-region" onclick="selectRegion('south')">South Shore</button>
                        <button class="btn-region" onclick="selectRegion('islands')">Islands</button>
                        <button class="btn-region" onclick="selectRegion('all')">All</button>
                        <button class="btn-region btn-clear" onclick="selectRegion('none')">‚úï</button>
                    </div>
                    <div class="control-label">Region</div>
                </div>

                <div class="sort-container">
                    <div class="sort-filter-buttons">
                        <button class="btn-sort active" id="sortAlphabetical" onclick="setSortMode('alphabetical')">A to Z</button>
                        <button class="btn-sort" id="sortDistance" onclick="setSortMode('distance')">Distance</button>
                    </div>
                    <div class="control-label">Sort</div>
                </div>
            </div>

            <div class="service-centers" id="serviceCenters">
                <!-- Service centers will be populated here -->
            </div>
        </div>

        <!-- Section 3: RMV Booking Configuration -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">3</span>üîó RMV Booking Configuration</h2>
            </div>
            <div class="section-instructions">
                <div class="main-instruction">Enter the RMV appointment booking URL that the system should monitor</div>
                <div class="sub-instruction">Provide your RMV appointment booking URL and set the expiration date. The system will search for available appointments and display them with your preferences highlighted.</div>
            </div>

            <div class="booking-grid">
                <div class="form-group">
                    <label for="rmvUrl">RMV Appointment Booking URL *</label>
                    <input type="url" id="rmvUrl" placeholder="https://atlas-myrmv.massdot.state.ma.us/myrmv/... or https://cxmflow.com/..." required>
                </div>
                <div class="form-group">
                    <label for="linkExpiration">Link Expiration Date</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="linkExpiration" class="date-input">
                        <span class="date-icon">‚ö†Ô∏è</span>
                    </div>
                    <div class="link-expiration-info">
                        System will notify you before this date to renew the booking link
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Section 4: Time Preferences -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">4</span>üïê Appointment Time Preferences</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Set your preferred date range and time window for appointments</div>
                <div class="sub-instruction">Choose your earliest and latest acceptable dates, then use the sliders to set your preferred time range. The system will prioritize appointments within your selected time window.</div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="startDate">Earliest Date</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="startDate" class="date-input">
                        <span class="date-icon">üìÖ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endDate">Latest Date</label>
                    <div class="date-input-wrapper">
                        <input type="date" id="endDate" class="date-input">
                        <span class="date-icon">üìÖ</span>
                    </div>
                </div>
            </div>

            <h4 style="margin: 20px 0 10px 0; color: #666;">Preferred Time Range (10-minute intervals):</h4>
            <div class="time-range-container">
                <div class="time-slider-group">
                    <label for="startTimeSlider">Earliest Time (9:00 AM - 4:50 PM)</label>
                    <input type="range" id="startTimeSlider" class="time-slider" min="54" max="101" value="54" step="1">
                    <div class="time-display" id="startTimeDisplay">9:00 AM</div>
                </div>
                <div class="time-slider-group">
                    <label for="endTimeSlider">Latest Time (9:10 AM - 5:00 PM)</label>
                    <input type="range" id="endTimeSlider" class="time-slider" min="55" max="102" value="102" step="1">
                    <div class="time-display" id="endTimeDisplay">5:00 PM</div>
                </div>
            </div>
        </div>

        <!-- Section 5: Notifications -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">5</span>üîî Notification Settings</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Configure how you want to be notified when appointments are found</div>
                <div class="sub-instruction">Enable your preferred notification methods. Email and SMS will use the contact information from Section 1. Additional notification services may require specific configuration.</div>
            </div>

            <div class="notifications-inline-container">
                <div class="notification-item">
                    <div class="notification-item-header">
                        <label class="notification-toggle">
                            <input type="checkbox" id="emailNotifications">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="notification-label">Email</div>
                    </div>
                    <div class="notification-active-info" id="emailInfo">
                        <span id="emailDisplay"></span>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-item-header">
                        <label class="notification-toggle">
                            <input type="checkbox" id="smsNotifications">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="notification-label">SMS</div>
                    </div>
                    <div class="notification-active-info" id="smsInfo">
                        <span id="phoneDisplay"></span>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-item-header">
                        <label class="notification-toggle">
                            <input type="checkbox" id="pushNotifications">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="notification-label">Browser</div>
                    </div>
                    <div class="notification-active-info" id="pushInfo">
                        <!-- No text for browser -->
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-item-header">
                        <label class="notification-toggle">
                            <input type="checkbox" id="webhookNotifications">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="notification-label">Webhook</div>
                    </div>
                    <div class="notification-active-info" id="webhookInfo">
                        <input type="url" id="webhookUrl" class="webhook-input" placeholder="https://your-webhook-endpoint.com/notify">
                    </div>
                </div>
            </div>


            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="startMonitoring()">Start Monitoring</button>
                <button class="btn btn-danger" onclick="stopMonitoring()" style="display: none;" id="stopBtn">Stop Monitoring</button>
            </div>
        </div>

        <!-- Section 6: Available Appointments -->
        <div class="card" id="appointmentsSection" style="display: none;">
            <div class="card-header">
                <h2><span class="section-number">6</span>üìÖ Available Appointments</h2>
            </div>
            <div class="section-instructions">
                <div class="main-instruction">Current appointment availability for selected locations</div>
                <div class="sub-instruction">Appointments matching your preferences are highlighted in green. All other available appointments are shown below. Next check in: <span id="nextCheckCountdown">--</span></div>
            </div>

            <div id="appointmentsContainer">
                <div class="appointments-loading">
                    <div class="loading-spinner"></div>
                    <p>Searching for appointments...</p>
                </div>
            </div>
        </div>

        <!-- Section 7: Statistics -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">7</span>üìä Live Statistics</h2>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Real-time monitoring statistics and performance metrics</div>
                <div class="sub-instruction">Track system activity including total checks performed, appointments found, and notifications sent.</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="checksCount">0</div>
                    <div class="stat-label">Total Checks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="availableCount">0</div>
                    <div class="stat-label">Appointments Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="notificationsSent">0</div>
                    <div class="stat-label">Notifications Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="matchingCount">0</div>
                    <div class="stat-label">Matching Preferences</div>
                </div>
            </div>
        </div>

        <!-- Section 8: Activity Log -->
        <div class="card">
            <div class="card-header">
                <h2><span class="section-number">8</span>üìù Activity Log</h2>
                <button class="btn btn-secondary" onclick="clearLog()" style="padding: 8px 16px; font-size: 0.9rem;">Clear Log</button>
            </div>

            <div class="section-instructions">
                <div class="main-instruction">Real-time system activity and monitoring updates</div>
                <div class="sub-instruction">View detailed logs of system activity including appointment checks, notifications sent, errors, and successful bookings. Green entries indicate success, red indicates errors, and blue indicates general information.</div>
            </div>

            <div class="monitor-log" id="monitorLog">
                <div class="log-entry info">System ready. Configure settings and click "Start Monitoring" to begin.</div>
            </div>
        </div>
    </div>

    <script>
        // Service Centers Data (alphabetically sorted with actual RMV addresses for distance calculation)
        const serviceCenters = [
            { name: 'Attleboro', address: '75 Park Street, Attleboro MA, 02703', lat: 41.9445, lng: -71.2856 },
            { name: 'Braintree', address: '10 Plain Street, Braintree MA, 02184', lat: 42.2057, lng: -70.9995 },
            { name: 'Brockton', address: '490 Forest Avenue, Brockton MA, 02301', lat: 42.0834, lng: -71.0184 },
            { name: 'Danvers', address: '8 Newbury Street, Danvers MA, 01923', lat: 42.5751, lng: -70.9301 },
            { name: 'Easthampton', address: '116 Pleasant St, East Hampton MA, 01027', lat: 42.2667, lng: -72.6687 },
            { name: 'Fall River', address: '1794 North Main Street, Fall River MA, 02720', lat: 41.7015, lng: -71.1550 },
            { name: 'Greenfield', address: '18 Miner Street, Greenfield MA, 01301', lat: 42.5876, lng: -72.6001 },
            { name: 'Haverhill', address: '229C Lincoln Avenue, Haverhill MA, 01830', lat: 42.7762, lng: -71.0773 },
            { name: 'Lawrence', address: '73C Winthrop Avenue, Lawrence MA, 01843', lat: 42.7070, lng: -71.1631 },
            { name: 'Leominster', address: '500 Research Drive, Leominster MA, 01453', lat: 42.5251, lng: -71.7612 },
            { name: 'Lowell', address: '77 Middlesex Street, Lowell MA, 01852', lat: 42.6334, lng: -71.3162 },
            { name: 'Martha\'s Vineyard', address: '11A Street, Martha\'s Vineyard/Edgertown MA, 02539', lat: 41.3890, lng: -70.5138 },
            { name: 'Milford', address: '138 South Main Street, Milford MA, 01757', lat: 42.1598, lng: -71.5201 },
            { name: 'Nantucket', address: '16 Broad Street, Nantucket MA, 02554', lat: 41.2835, lng: -70.0995 },
            { name: 'New Bedford', address: '212 Theodore Rice Blvd, New Bedford MA, 02740', lat: 41.6362, lng: -70.9342 },
            { name: 'North Adams', address: '33 Main Street, North Adams MA, 01247', lat: 42.7001, lng: -73.1087 },
            { name: 'Pittsfield', address: '333 East Street, Pittsfield MA, 01201', lat: 42.4501, lng: -73.2451 },
            { name: 'Plymouth', address: '40 Industrial Park, Plymouth MA, 02360', lat: 41.9584, lng: -70.6673 },
            { name: 'South Yarmouth', address: '1084 Route 28, South Yarmouth, MA 02664', lat: 41.6707, lng: -70.1995 },
            { name: 'Southbridge', address: '6 Larochelle Way, Southbridge MA, 01550', lat: 42.0751, lng: -72.0334 },
            { name: 'Springfield', address: '1250 St. James Avenue, Springfield MA, 01104', lat: 42.1015, lng: -72.5898 },
            { name: 'Taunton', address: '1 Washington Street, Suite 40, Taunton MA, 02780', lat: 41.9001, lng: -71.0897 },
            { name: 'Watertown', address: '550 Arsenal Street, Watertown MA, 02472', lat: 42.3584, lng: -71.1828 },
            { name: 'Wilmington', address: '355 Middlesex Avenue, Wilmington MA, 01887', lat: 42.5584, lng: -71.1737 },
            { name: 'Worcester', address: '50 SW Cutoff, Worcester MA, 16034', lat: 42.2626, lng: -71.8023 }
        ];

        // Regional groupings
        const regions = {
            boston: ['Watertown', 'Braintree'],
            worcester: ['Worcester', 'Milford', 'Leominster', 'Southbridge'],
            springfield: ['Springfield', 'Easthampton', 'Pittsfield', 'North Adams', 'Greenfield'],
            north: ['Danvers', 'Lawrence', 'Haverhill', 'Lowell', 'Wilmington'],
            south: ['Brockton', 'Taunton', 'Fall River', 'Attleboro', 'New Bedford', 'Plymouth', 'South Yarmouth'],
            islands: ['Martha\'s Vineyard', 'Nantucket']
        };

        // ZIP code to coordinates mapping (expanded Massachusetts coverage)
        const zipCoords = {
            // Boston Area
            '02101': { lat: 42.3601, lng: -71.0589, city: 'Boston' },
            '02109': { lat: 42.3651, lng: -71.0536, city: 'Boston' },
            '02134': { lat: 42.3584, lng: -71.1311, city: 'Allston' },
            '02138': { lat: 42.3736, lng: -71.1097, city: 'Cambridge' },
            '02184': { lat: 42.2057, lng: -70.9995, city: 'Braintree' },
            '02472': { lat: 42.3584, lng: -71.1828, city: 'Watertown' },
            // North Shore
            '01923': { lat: 42.5751, lng: -70.9301, city: 'Danvers' },
            '01843': { lat: 42.7070, lng: -71.1631, city: 'Lawrence' },
            '01830': { lat: 42.7762, lng: -71.0773, city: 'Haverhill' },
            '01852': { lat: 42.6334, lng: -71.3162, city: 'Lowell' },
            '01887': { lat: 42.5584, lng: -71.1737, city: 'Wilmington' },
            // Central MA
            '01605': { lat: 42.2626, lng: -71.8023, city: 'Worcester' },
            '01757': { lat: 42.1598, lng: -71.5201, city: 'Milford' },
            '01453': { lat: 42.5251, lng: -71.7612, city: 'Leominster' },
            '01550': { lat: 42.0751, lng: -72.0334, city: 'Southbridge' },
            // Western MA
            '01104': { lat: 42.1015, lng: -72.5898, city: 'Springfield' },
            '01027': { lat: 42.2667, lng: -72.6687, city: 'Easthampton' },
            '01201': { lat: 42.4501, lng: -73.2451, city: 'Pittsfield' },
            '01247': { lat: 42.7001, lng: -73.1087, city: 'North Adams' },
            '01301': { lat: 42.5876, lng: -72.6001, city: 'Greenfield' },
            // South Shore
            '02301': { lat: 42.0834, lng: -71.0184, city: 'Brockton' },
            '02780': { lat: 41.9001, lng: -71.0897, city: 'Taunton' },
            '02720': { lat: 41.7015, lng: -71.1550, city: 'Fall River' },
            '02703': { lat: 41.9445, lng: -71.2856, city: 'Attleboro' },
            '02740': { lat: 41.6362, lng: -70.9342, city: 'New Bedford' },
            '02360': { lat: 41.9584, lng: -70.6673, city: 'Plymouth' },
            '02664': { lat: 41.6707, lng: -70.1995, city: 'South Yarmouth' },
            // Islands
            '02539': { lat: 41.3890, lng: -70.5138, city: 'Edgartown' },
            '02554': { lat: 41.2835, lng: -70.0995, city: 'Nantucket' },
            // Missing North Shore ZIPs
            '01944': { lat: 42.5778, lng: -70.7692, city: 'Manchester' },
            '01915': { lat: 42.5584, lng: -70.8800, city: 'Beverly' },
            '01945': { lat: 42.5001, lng: -70.8578, city: 'Marblehead' },
            '01960': { lat: 42.5278, lng: -70.9286, city: 'Peabody' },
            '01970': { lat: 42.5195, lng: -70.8967, city: 'Salem' },
            '01966': { lat: 42.5584, lng: -70.8800, city: 'Rockport' },
            '01982': { lat: 42.6167, lng: -70.9481, city: 'Hamilton' },
            '01983': { lat: 42.6167, lng: -70.9481, city: 'Topsfield' },
            '01929': { lat: 42.6334, lng: -70.9634, city: 'Essex' },
            '01930': { lat: 42.6334, lng: -70.9634, city: 'Gloucester' },
            '01938': { lat: 42.6334, lng: -70.9634, city: 'Ipswich' },
            '01950': { lat: 42.7928, lng: -70.8734, city: 'Newburyport' },
            '01951': { lat: 42.7928, lng: -70.8734, city: 'Newbury' },
            '01952': { lat: 42.5834, lng: -70.8578, city: 'Salisbury' },
            '01969': { lat: 42.5584, lng: -70.8800, city: 'Rowley' },
            '01984': { lat: 42.6584, lng: -70.8800, city: 'Wenham' },
            '01985': { lat: 42.6584, lng: -70.8800, city: 'West Newbury' }
        };

        // Time conversion functions (10-minute intervals)
        function sliderValueToTime(value) {
            const totalMinutes = value * 10;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const displayHours = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
            const period = hours < 12 ? 'AM' : 'PM';
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // State management
        let monitoringInterval = null;
        let selectedCenters = new Set();
        let activeRegions = new Set();
        let sortMode = 'alphabetical';
        let centersWithDistance = null;
        let userZipCoords = null;
        let stats = {
            checks: 0,
            available: 0,
            notifications: 0,
            matching: 0
        };

        // Countdown timer variables
        let nextCheckTime = null;
        let countdownInterval = null;

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Radius of Earth in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Initialize UI
        function initializeUI() {
            // Initially populate service centers alphabetically
            populateServiceCenters();
            // Disable distance sorting initially (no ZIP entered)
            document.getElementById('sortDistance').disabled = true;

            // Set default dates
            const today = new Date();
            const linkExp = new Date();
            linkExp.setDate(today.getDate() + 5); // 5 days default as requested

            document.getElementById('startDate').value = today.toISOString().split('T')[0]; // Current date
            document.getElementById('endDate').value = linkExp.toISOString().split('T')[0]; // Link expiration date
            document.getElementById('linkExpiration').value = linkExp.toISOString().split('T')[0];

            // Initialize time sliders
            updateTimeDisplay();

            // Add event listeners
            document.getElementById('startTimeSlider').addEventListener('input', updateTimeDisplay);
            document.getElementById('endTimeSlider').addEventListener('input', updateTimeDisplay);
            document.getElementById('zipCode').addEventListener('input', handleZipCodeInput);
            document.getElementById('email').addEventListener('input', updateNotificationInfo);
            document.getElementById('phone').addEventListener('input', formatPhoneInput);
            
            // Notification toggle listeners
            document.getElementById('emailNotifications').addEventListener('change', toggleNotificationInfo);
            document.getElementById('smsNotifications').addEventListener('change', toggleNotificationInfo);
            document.getElementById('pushNotifications').addEventListener('change', toggleNotificationInfo);
            document.getElementById('webhookNotifications').addEventListener('change', toggleConditionalInput);

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Populate service centers
        function populateServiceCenters(sortedCenters = null) {
            const centersContainer = document.getElementById('serviceCenters');
            centersContainer.innerHTML = '';
            
            const centers = sortedCenters || serviceCenters;
            centers.forEach(center => {
                const div = document.createElement('div');
                div.className = 'service-center';
                div.setAttribute('data-name', center.name || center);
                
                if (center.distance) {
                    div.innerHTML = `
                        ${center.name}
                        <div class="distance-badge">${Math.round(center.distance)}mi</div>
                    `;
                } else {
                    div.textContent = center.name || center;
                }
                
                div.onclick = () => toggleSelection(div, center.name || center);
                centersContainer.appendChild(div);
            });
        }

        // Handle ZIP code input
        function handleZipCodeInput() {
            const zipCode = document.getElementById('zipCode').value;
            const cityField = document.getElementById('city');
            
            if (zipCode.length === 5 && /^\d{5}$/.test(zipCode)) {
                lookupZipCode(zipCode);
            } else if (zipCode.length === 0) {
                // Clear city when ZIP is removed
                cityField.value = '';
                userZipCoords = null;
                centersWithDistance = null;
                // Reset to alphabetical sort
                setSortMode('alphabetical');
                addLog('ZIP code cleared - reset to alphabetical sorting', 'info');
            } else if (zipCode.length > 0 && zipCode.length < 5) {
                // Clear city while typing invalid ZIP
                cityField.value = '';
            }
        }

        // Restore selections after repopulating centers
        function restoreSelections() {
            const serviceCenterElements = document.querySelectorAll('.service-center');
            serviceCenterElements.forEach(element => {
                const centerName = element.getAttribute('data-name');
                if (selectedCenters.has(centerName)) {
                    element.classList.add('selected');
                }
            });
        }

        // Set sort mode
        function setSortMode(mode) {
            sortMode = mode;
            
            // Update button states
            document.getElementById('sortAlphabetical').classList.toggle('active', mode === 'alphabetical');
            document.getElementById('sortDistance').classList.toggle('active', mode === 'distance');
            
            // Re-sort and update display
            if (mode === 'distance' && userZipCoords) {
                populateServiceCenters(centersWithDistance);
            } else {
                populateServiceCenters(serviceCenters); // Original alphabetical order
            }
            
            // Restore selections after repopulating
            restoreSelections();
            
            addLog(`Sort mode changed to: ${mode}`, 'info');
        }

        // Lookup ZIP code and update city, calculate distances
        function lookupZipCode(zipCode) {
            if (!zipCode || zipCode.length < 5) {
                document.getElementById('city').value = '';
                userZipCoords = null;
                centersWithDistance = [];
                document.getElementById('sortDistance').disabled = true;
                if (sortMode === 'distance') {
                    setSortMode('alphabetical');
                }
                return;
            }
            
            // In production, this would call a real geocoding API
            if (zipCoords[zipCode]) {
                const coords = zipCoords[zipCode];
                document.getElementById('city').value = coords.city;
                userZipCoords = coords;
                
                // Calculate distances and sort service centers
                centersWithDistance = serviceCenters.map(center => ({
                    ...center,
                    distance: calculateDistance(coords.lat, coords.lng, center.lat, center.lng)
                })).sort((a, b) => a.distance - b.distance);
                
                // Enable distance sorting
                document.getElementById('sortDistance').disabled = false;
                
                // Log distances
                console.log('Service center distances from', zipCode + ':', coords.city);
                centersWithDistance.forEach(center => {
                    console.log(`${center.name} (${center.address}): ${Math.round(center.distance)} miles`);
                });
                
                // Update UI based on current sort mode
                if (sortMode === 'distance') {
                    populateServiceCenters(centersWithDistance);
                }
                
                addLog(`ZIP ${zipCode} found: ${coords.city}. Distance sorting enabled.`, 'info');
            } else {
                // Handle unknown ZIP - clear city and keep alphabetical
                document.getElementById('city').value = '';
                userZipCoords = null;
                centersWithDistance = [];
                document.getElementById('sortDistance').disabled = true;
                
                if (sortMode === 'distance') {
                    setSortMode('alphabetical');
                }
                
                addLog(`ZIP code ${zipCode} not found. Distance sorting disabled.`, 'info');
            }
        }

        // Regional selection
        function selectRegion(regionKey) {
            const regionButton = event.target;
            
            if (regionKey === 'all') {
                serviceCenters.forEach(center => {
                    const element = document.querySelector(`[data-name="${center.name}"]`);
                    if (element) {
                        element.classList.add('selected');
                        selectedCenters.add(center.name);
                    }
                });
                // Clear all active regions and mark all as active
                document.querySelectorAll('.btn-region:not(.btn-clear)').forEach(btn => {
                    btn.classList.add('active');
                });
                activeRegions = new Set(['boston', 'worcester', 'springfield', 'north', 'south', 'islands']);
                addLog(`Selected all ${serviceCenters.length} service centers`, 'info');
            } else if (regionKey === 'none') {
                selectedCenters.clear();
                activeRegions.clear();
                document.querySelectorAll('.service-center').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelectorAll('.btn-region:not(.btn-clear)').forEach(btn => {
                    btn.classList.remove('active');
                });
                addLog('Cleared all service center selections', 'info');
            } else if (regions[regionKey]) {
                // Toggle region
                if (activeRegions.has(regionKey)) {
                    // Deactivate region
                    activeRegions.delete(regionKey);
                    regionButton.classList.remove('active');
                    regions[regionKey].forEach(centerName => {
                        const element = document.querySelector(`[data-name="${centerName}"]`);
                        if (element) {
                            element.classList.remove('selected');
                            selectedCenters.delete(centerName);
                        }
                    });
                    addLog(`Deselected ${regions[regionKey].length} centers in ${regionKey} region`, 'info');
                } else {
                    // Activate region
                    activeRegions.add(regionKey);
                    regionButton.classList.add('active');
                    regions[regionKey].forEach(centerName => {
                        const element = document.querySelector(`[data-name="${centerName}"]`);
                        if (element) {
                            element.classList.add('selected');
                            selectedCenters.add(centerName);
                        }
                    });
                    addLog(`Selected ${regions[regionKey].length} centers in ${regionKey} region`, 'info');
                }
            }
        }

        // Update notification info displays
        // Format phone input
        function formatPhoneInput(event) {
            let value = event.target.value.replace(/\D/g, ''); // Remove non-digits
            
            if (value.length >= 6) {
                value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
            } else if (value.length >= 3) {
                value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
            }
            
            event.target.value = value;
            updateNotificationInfo();
        }

        function updateNotificationInfo() {
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            
            document.getElementById('emailDisplay').textContent = email || '(enter email above)';
            document.getElementById('phoneDisplay').textContent = phone || '(enter phone above)';
        }

        // Toggle notification info visibility
        function toggleNotificationInfo(event) {
            const notificationType = event.target.id.replace('Notifications', '');
            const infoElement = document.getElementById(notificationType + 'Info');
            
            if (event.target.checked) {
                infoElement.classList.add('show');
                if (notificationType === 'email' || notificationType === 'sms') {
                    updateNotificationInfo();
                }
            } else {
                infoElement.classList.remove('show');
            }
        }

        function updateTimeDisplay() {
            const startValue = document.getElementById('startTimeSlider').value;
            const endValue = document.getElementById('endTimeSlider').value;
            
            document.getElementById('startTimeDisplay').textContent = sliderValueToTime(startValue);
            document.getElementById('endTimeDisplay').textContent = sliderValueToTime(endValue);

            // Ensure start time is not after end time
            if (parseInt(startValue) >= parseInt(endValue)) {
                document.getElementById('endTimeSlider').value = parseInt(startValue) + 1;
                document.getElementById('endTimeDisplay').textContent = sliderValueToTime(parseInt(startValue) + 1);
            }
        }

        function toggleConditionalInput() {
            const webhookInfo = document.getElementById('webhookInfo');
            const isChecked = document.getElementById('webhookNotifications').checked;
            
            if (isChecked) {
                webhookInfo.classList.add('show');
            } else {
                webhookInfo.classList.remove('show');
            }
        }

        // Toggle selection for service centers
        function toggleSelection(element, value) {
            element.classList.toggle('selected');
            if (selectedCenters.has(value)) {
                selectedCenters.delete(value);
            } else {
                selectedCenters.add(value);
            }
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const log = document.getElementById('monitorLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // Clear log
        function clearLog() {
            const log = document.getElementById('monitorLog');
            log.innerHTML = '<div class="log-entry info">Log cleared.</div>';
        }

        // Validate form
        function validateForm() {
            const required = ['firstName', 'lastName', 'email', 'phone', 'zipCode', 'rmvUrl'];
            for (const field of required) {
                if (!document.getElementById(field).value.trim()) {
                    const fieldName = field.replace(/([A-Z])/g, ' $1').toLowerCase()
                        .replace('rmv url', 'RMV URL')
                        .replace('zipcode', 'ZIP Code');
                    addLog(`Please fill in ${fieldName}`, 'error');
                    return false;
                }
            }

            // Validate ZIP code format
            const zipCode = document.getElementById('zipCode').value;
            if (!/^\d{5}$/.test(zipCode)) {
                addLog('Please enter a valid 5-digit ZIP code', 'error');
                return false;
            }

            if (selectedCenters.size === 0) {
                addLog('Please select at least one service center from Section 2', 'error');
                return false;
            }

            // Validate URL format
            const rmvUrl = document.getElementById('rmvUrl').value;
            if (!rmvUrl.includes('massdot.state.ma.us') && !rmvUrl.includes('cxmflow.com')) {
                addLog('Please enter a valid RMV booking URL (should contain massdot.state.ma.us or cxmflow.com)', 'error');
                return false;
            }

            // Check link expiration date
            const linkExpiration = document.getElementById('linkExpiration').value;
            if (linkExpiration) {
                const expDate = new Date(linkExpiration);
                const today = new Date();
                if (expDate <= today) {
                    addLog('Link expiration date should be in the future', 'error');
                    return false;
                }
            }

            return true;
        }

        // Start monitoring
        async function startMonitoring() {
            if (!validateForm()) return;

            // Update UI
            document.getElementById('monitorStatus').textContent = 'ACTIVE';
            document.getElementById('monitorStatus').className = 'status-badge status-active';
            document.querySelector('.btn-primary').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';

            const startTime = sliderValueToTime(document.getElementById('startTimeSlider').value);
            const endTime = sliderValueToTime(document.getElementById('endTimeSlider').value);

            addLog('Monitoring started successfully', 'success');
            addLog(`Monitoring ${selectedCenters.size} service centers`, 'info');
            addLog(`Preferred time window: ${startTime} - ${endTime}`, 'info');

            // Show appointments section
            document.getElementById('appointmentsSection').style.display = 'block';
            
            // Start the monitoring loop
            checkAppointments(); // Initial check
            monitoringInterval = setInterval(checkAppointments, getCheckInterval());
            
            // Start countdown timer
            startCountdownTimer();
        }

        // Stop monitoring
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            // Update UI
            document.getElementById('monitorStatus').textContent = 'INACTIVE';
            document.getElementById('monitorStatus').className = 'status-badge status-inactive';
            document.querySelector('.btn-primary').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('appointmentsSection').style.display = 'none';

            addLog('Monitoring stopped', 'info');
        }

        // Get check interval based on current time
        function getCheckInterval() {
            const now = new Date();
            const hour = now.getHours();

            // Check every 5 minutes during business hours, every 30 minutes otherwise
            if (hour >= 9 && hour <= 16) {
                return 5 * 60 * 1000; // 5 minutes
            } else {
                return 30 * 60 * 1000; // 30 minutes
            }
        }

        // Check appointments (mock implementation)
        async function checkAppointments() {
            stats.checks++;
            updateStats();

            const rmvUrl = document.getElementById('rmvUrl').value;
            addLog(`Checking appointments for ${selectedCenters.size} centers at ${rmvUrl}`, 'info');

            // Get live appointment data from RMV system
            const rmvCheckResults = await checkRMVAppointments();

            if (rmvCheckResults.found) {
                stats.available += rmvCheckResults.appointments.length;
                updateStats();

                addLog(`Found ${rmvCheckResults.appointments.length} available appointments!`, 'success');

                // Send notifications
                await sendNotifications(rmvCheckResults.appointments);

                // Display appointments with preference highlighting
                displayAppointments(rmvCheckResults.appointments);
            } else {
                addLog('No appointments available at this time', 'info');
                displayNoAppointments();
            }
        }

        // Live RMV appointment checking (replaces mock data)
        async function checkRMVAppointments() {
            const rmvUrl = document.getElementById('rmvUrl').value;
            const selectedCentersList = Array.from(selectedCenters);
            
            addLog('Starting RMV appointment extraction...', 'info');
            
            try {
                // Call backend scraping service
                const response = await fetch('/api/scrape-rmv-appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rmvUrl: rmvUrl,
                        selectedCenters: selectedCentersList,
                        userPreferences: {
                            startDate: document.getElementById('startDate').value,
                            endDate: document.getElementById('endDate').value,
                            startTime: sliderValueToTime(document.getElementById('startTimeSlider').value),
                            endTime: sliderValueToTime(document.getElementById('endTimeSlider').value)
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.error) {
                    addLog(`Scraping error: ${result.error}`, 'error');
                    return { found: false, appointments: [], error: result.error };
                }

                if (result.appointments && result.appointments.length > 0) {
                    addLog(`Found ${result.appointments.length} appointments across ${result.locationsChecked} locations`, 'success');
                    return { 
                        found: true, 
                        appointments: result.appointments,
                        locationsChecked: result.locationsChecked
                    };
                } else {
                    addLog(`No appointments available at ${result.locationsChecked || selectedCentersList.length} locations`, 'info');
                    return { found: false, appointments: [], locationsChecked: result.locationsChecked };
                }

            } catch (error) {
                addLog(`Failed to check appointments: ${error.message}`, 'error');
                return { found: false, appointments: [], error: error.message };
            }
        }

        // Send notifications
        async function sendNotifications(appointments) {
            const emailEnabled = document.getElementById('emailNotifications').checked;
            const smsEnabled = document.getElementById('smsNotifications').checked;
            const pushEnabled = document.getElementById('pushNotifications').checked;
            const webhookEnabled = document.getElementById('webhookNotifications').checked;
            const webhookUrl = document.getElementById('webhookUrl').value;

            // Browser push notification
            if (pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('RMV Appointments Available!', {
                    body: `Found ${appointments.length} appointments matching your criteria`,
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png',
                    vibrate: [200, 100, 200]
                });

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }

            // Log notification sending (actual implementation would send real notifications)
            if (emailEnabled) {
                addLog(`Email notification sent to ${document.getElementById('email').value}`, 'success');
                stats.notifications++;
            }

            if (smsEnabled) {
                addLog(`SMS notification sent to ${document.getElementById('phone').value}`, 'success');
                stats.notifications++;
            }

            if (webhookEnabled && webhookUrl) {
                try {
                    addLog(`Webhook notification sent to ${webhookUrl}`, 'success');
                    stats.notifications++;
                } catch (error) {
                    addLog(`Failed to send webhook notification: ${error.message}`, 'error');
                }
            }

            updateStats();
        }


        // Display appointments with preference highlighting
        function displayAppointments(appointments) {
            const container = document.getElementById('appointmentsContainer');
            
            if (!appointments || appointments.length === 0) {
                displayNoAppointments();
                return;
            }

            // Check user preferences
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const startTimeSlider = document.getElementById('startTimeSlider').value;
            const endTimeSlider = document.getElementById('endTimeSlider').value;
            
            const preferredAppointments = [];
            const otherAppointments = [];
            
            appointments.forEach(apt => {
                const aptDate = new Date(apt.date);
                const aptTime = timeToSliderValue(apt.time);
                
                const matchesPreferences = aptDate >= startDate && 
                                         aptDate <= endDate && 
                                         aptTime >= startTimeSlider && 
                                         aptTime <= endTimeSlider;
                
                if (matchesPreferences) {
                    preferredAppointments.push(apt);
                    stats.matching++;
                } else {
                    otherAppointments.push(apt);
                }
            });
            
            updateStats();
            
            // Create appointments grid
            const grid = document.createElement('div');
            grid.className = 'appointments-grid';
            
            // Add preferred appointments first
            preferredAppointments.forEach(apt => {
                grid.appendChild(createAppointmentCard(apt, true));
            });
            
            // Add other appointments
            otherAppointments.forEach(apt => {
                grid.appendChild(createAppointmentCard(apt, false));
            });
            
            container.innerHTML = '';
            container.appendChild(grid);
        }

        function createAppointmentCard(appointment, isPreferred) {
            const card = document.createElement('div');
            card.className = `appointment-card ${isPreferred ? 'preferred' : ''}`;
            
            card.innerHTML = `
                <div class="appointment-location">${appointment.center}</div>
                <div class="appointment-datetime">${appointment.date} at ${appointment.time}</div>
                <a href="${appointment.url}" target="_blank" class="appointment-link">Book Appointment</a>
            `;
            
            return card;
        }

        function displayNoAppointments() {
            const container = document.getElementById('appointmentsContainer');
            const nextCheckInterval = Math.floor(getCheckInterval() / 1000 / 60);
            
            container.innerHTML = `
                <div class="no-appointments">
                    <h3>No appointments currently available</h3>
                    <p>Checking again in <span class="countdown-timer" id="nextCheckCountdown">${nextCheckInterval} minutes</span></p>
                </div>
            `;
        }

        // Countdown timer functions
        function startCountdownTimer() {
            nextCheckTime = Date.now() + getCheckInterval();
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function updateCountdown() {
            if (!nextCheckTime) return;
            
            const now = Date.now();
            const timeLeft = nextCheckTime - now;
            
            if (timeLeft <= 0) {
                nextCheckTime = Date.now() + getCheckInterval();
                document.getElementById('nextCheckCountdown').textContent = Math.floor(getCheckInterval() / 1000 / 60) + ' minutes';
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            const countdownElements = document.querySelectorAll('#nextCheckCountdown, .countdown-timer');
            countdownElements.forEach(el => {
                el.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });
        }

        // Helper function to convert time string to slider value
        function timeToSliderValue(timeStr) {
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes;
            
            if (period === 'PM' && hours !== 12) totalMinutes += 12 * 60;
            if (period === 'AM' && hours === 12) totalMinutes = minutes;
            
            // Convert to slider value (9 AM = 54)
            return Math.floor((totalMinutes - 9 * 60) / 10) + 54;
        }

        // Update statistics display
        function updateStats() {
            document.getElementById('checksCount').textContent = stats.checks;
            document.getElementById('availableCount').textContent = stats.available;
            document.getElementById('notificationsSent').textContent = stats.notifications;
            document.getElementById('matchingCount').textContent = stats.matching;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeUI);

        // Handle page visibility change to adjust monitoring frequency
        document.addEventListener('visibilitychange', () => {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                if (!document.hidden) {
                    monitoringInterval = setInterval(checkAppointments, getCheckInterval());
                    addLog('Monitoring resumed', 'info');
                }
            }
        });
    </script>
</body>
</html>